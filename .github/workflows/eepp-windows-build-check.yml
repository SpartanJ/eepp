name: Windows

on: [push, pull_request]

jobs:
  Windows:
    runs-on: windows-latest
    env:
      MSBUILD_PATH: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\
    steps:
    - name: Configure Git
      shell: cmd
      run: |
        git config --system core.autocrlf false
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
        fetch-depth: 2
    - name: Checkout submodules
      run: |
        git submodule update --init --recursive
    - name: Install dependencies
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/premake/premake-core/releases/download/v5.0.0-beta6/premake-5.0.0-beta6-windows.zip" -OutFile "premake-5.0.0-beta6-windows.zip"
        Expand-Archive -DestinationPath . -Path premake-5.0.0-beta6-windows.zip
    - name: Create project
      shell: powershell
      run: |
        ./premake5.exe --windows-vc-build --with-text-shaper --disable-static-build vs2022
    - name: Build
      shell: cmd
      run: |
        "%MSBUILD_PATH%\MSBuild.exe" .\make\windows\eepp.sln -m /p:Platform="x64" /p:Configuration="release"
    - name: Download Mesa3D for Windows
      run: |
        Invoke-WebRequest -Uri "https://github.com/pal1000/mesa-dist-win/releases/download/25.2.4/mesa3d-25.2.4-release-msvc.7z" -OutFile "mesa.7z"
        7z x mesa.7z -o"C:\mesa"
      shell: powershell
    - name: Set up Mesa DLLs
      run: |
        copy C:\mesa\x64\opengl32.dll .
        copy C:\mesa\x64\libglapi.dll .
        # Add Mesa to PATH for dependencies
        set PATH=C:\mesa\x64;%PATH%
      shell: cmd
    - name: Unit Tests
      shell: cmd
      run: |
        set LIBGL_ALWAYS_SOFTWARE=1
        set GALLIUM_DRIVER=llvmpipe
        bin\unit_tests\eepp-unit_tests.exe
    - name: Upload test artifacts if folder exists
      if: always()
      shell: cmd
      run: |
        if exist bin\unit_tests\output (
          echo Artifact folder exists, uploading...
          exit 0
        ) else (
          echo No artifact folder (bin\unit_tests\output), tests passed, skipping upload.
          exit 0
        )
      id: upload-check
    - name: Upload artifacts
      if: always() && steps.upload-check.outputs.result == '0' && exists('bin/unit_tests/output')
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-output
        path: bin\unit_tests\output\*
